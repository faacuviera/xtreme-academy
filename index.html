<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="theme-color" content="#0a0a0a"/>
  <title>Xtreme Academy - Cuentas</title>
  <link rel="manifest" href="manifest.json"/>
  <link rel="icon" href="icon-192.png"/>
  <link rel="apple-touch-icon" href="icon-192.png"/>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
<header class="site-header">
  <div class="header-inner">
    <div class="brand">
      <img src="icon-512.png" alt="Xtreme Academy"/>
      <div class="t">
        <strong>Xtreme Academy — Cuentas</strong>
        <span id="activeTemplateLabel">Plantilla: —</span>
      </div>
    </div>
    <form class="header-search" role="search" aria-label="Buscador de clases, profes y alumnos">
      <label class="sr-only" for="directorySearch">Buscar en el listado</label>
      <input id="directorySearch" type="search" placeholder="Buscar clases, profes o alumnos" aria-label="Buscar en el listado" />
    </form>
    <p id="directorySearchFeedback" class="directory-search-feedback small" aria-live="polite" aria-atomic="true"></p>
    <div class="directory-toggle-wrap">
      <button type="button" id="directoryToggle" class="ghost directory-toggle" aria-expanded="false" aria-controls="directoryMenu">Dirección general</button>
      <nav id="directoryMenu" class="section-links" role="navigation" aria-label="Navegación de secciones académicas">
        <button type="button" data-directory-target="clases" aria-controls="directoryPanel">Clases</button>
        <button type="button" data-directory-target="profes" aria-controls="directoryPanel">Profes</button>
        <button type="button" data-directory-target="alumnos" aria-controls="directoryPanel">Alumnos</button>
        <button class="back-to-finance" type="button" id="backToFinanceBtn">Volver a finanzas</button>
      </nav>
    </div>
  </div>
  <div class="nav" role="tablist" aria-label="Secciones financieras">
    <button data-tab="dashboard" class="active">Resumen</button>
    <button data-tab="ingresos">Ingresos</button>
    <button data-tab="gastos">Egresos</button>
    <button data-tab="cxc">Por cobrar</button>
    <button data-tab="cxp">Por pagar</button>
    <button data-tab="inventario">Inventario</button>
    <button data-tab="alumnos">Alumnos</button>
    <button data-tab="plantillas">Plantillas</button>
  </div>
</header>

<div id="appAlerts" class="app-alerts" aria-live="polite" aria-atomic="true"></div>

<main id="directoryPanel" class="container directory-panel" aria-label="Directorio académico">
  <section class="directory" aria-label="Atajos a clases, profes y alumnos">
    <div class="directory-grid">
      <article class="directory-card" id="clases">
        <header class="directory-card__title">Clases</header>
        <form class="directory-form" id="classForm" aria-label="Agregar o editar clase">
          <div class="directory-form__row">
            <label for="className">Nombre</label>
            <input id="className" name="className" required placeholder="Ej: Infantiles" />
          </div>
          <div class="directory-form__row">
            <label for="classSchedule">Horario</label>
            <input id="classSchedule" name="classSchedule" placeholder="Ej: Lunes 18:00" />
          </div>
          <div class="directory-form__row">
            <label for="classLocation">Sede</label>
            <input id="classLocation" name="classLocation" placeholder="Ej: Do Jang Norte" />
          </div>
          <div class="directory-form__actions">
            <button class="primary" type="submit" id="classSaveBtn">Guardar clase</button>
            <button class="ghost" type="button" id="classCancelBtn">Cancelar</button>
          </div>
          <input type="hidden" id="classId" />
        </form>
        <div class="directory-list" id="classesList" data-filter-section="clases" data-section-label="Clases" role="list"></div>
        <p class="directory-empty" data-empty-default="Sin clases para este término." aria-live="polite" hidden>Sin clases para este término.</p>
      </article>
      <article class="directory-card" id="profes">
        <header class="directory-card__title">Profes</header>
        <form class="directory-form" id="teacherForm" aria-label="Agregar o editar profesor">
          <div class="directory-form__row">
            <label for="teacherName">Nombre</label>
            <input id="teacherName" name="teacherName" required placeholder="Ej: Sensei Lucía Suárez" />
          </div>
          <div class="directory-form__row">
            <label for="teacherFocus">Especialidad / nivel</label>
            <input id="teacherFocus" name="teacherFocus" placeholder="Ej: Infantiles" />
          </div>
          <div class="directory-form__row">
            <label for="teacherClasses">Clases asignadas</label>
            <select id="teacherClasses" name="teacherClasses" multiple aria-label="Seleccionar clases para el profesor"></select>
            <p class="small">Usá Ctrl/Cmd para seleccionar varias.</p>
          </div>
          <div class="directory-form__actions">
            <button class="primary" type="submit" id="teacherSaveBtn">Guardar profesor</button>
            <button class="ghost" type="button" id="teacherCancelBtn">Cancelar</button>
          </div>
          <input type="hidden" id="teacherId" />
        </form>
        <div class="directory-list" id="teachersList" data-filter-section="profes" data-section-label="Profes" role="list"></div>
        <p class="directory-empty" data-empty-default="Sin profes que coincidan." aria-live="polite" hidden>Sin profes que coincidan.</p>
      </article>
      <article class="directory-card" id="alumnos">
        <header class="directory-card__title">Alumnos</header>
        <ul class="directory-list" data-filter-section="alumnos" data-section-label="Alumnos" role="list">
          <li class="directory-item" data-label="Juan Pérez" role="listitem">
            <span class="directory-item__text">Juan Pérez</span>
            <span class="tag">Básico</span>
          </li>
          <li class="directory-item" data-label="Lucía Martínez" role="listitem">
            <span class="directory-item__text">Lucía Martínez</span>
            <span class="tag">BBC</span>
          </li>
          <li class="directory-item" data-label="Camila Ríos" role="listitem">
            <span class="directory-item__text">Camila Ríos</span>
            <span class="tag">Líder</span>
          </li>
        </ul>
        <p class="directory-empty" data-empty-default="Sin alumnos para mostrar." aria-live="polite" hidden>Sin alumnos para mostrar.</p>
      </article>
    </div>
  </section>
</main>

<main id="financePanel" class="container">

  <!-- DASHBOARD -->
  <section id="tab-dashboard" class="tab">
    <div class="card">
      <h2>Resumen del mes</h2>
      <div class="body">
        <div class="kpis">
          <div class="kpi"><div class="l">Ingresos</div><div class="n" id="kpiIngresos">$ 0</div></div>
          <div class="kpi"><div class="l">Egresos</div><div class="n" id="kpiGastos">$ 0</div></div>
          <div class="kpi"><div class="l">Balance</div><div class="n" id="kpiBalance">$ 0</div><div class="small" id="kpiHint"></div></div>
        </div>
        <div class="row" style="margin-top:12px;">
          <div>
            <label>Filtrar por mes</label>
            <input id="monthFilter" type="month"/>
          </div>
          <div>
            <label>Búsqueda rápida</label>
            <input id="searchAll" placeholder="Ej: Lucía, CUOTA, UTE..."/>
          </div>
        </div>
        <div class="actions">
          <button class="primary" id="exportBackupBtn">Exportar respaldo (JSON)</button>
          <button class="ghost" id="exportCsvAllBtn">Exportar TODO (CSV ZIP)</button>
        </div>
        <div id="searchResults" class="search-results" aria-live="polite">
          <div class="search-results__header">
            <div class="search-results__title">Resultados en todas las plantillas</div>
            <div class="small" id="searchResultsCount">Buscá por nombre, concepto o proveedor.</div>
          </div>
          <div id="searchResultsList" class="search-results__list small">
            Escribí algo en “Búsqueda rápida” para ver coincidencias.
          </div>
        </div>
        <p class="small" style="margin-top:10px;">
          Tip: en iPhone instalá como app desde Safari → Compartir → “Agregar a pantalla de inicio”.
        </p>
      </div>
    </div>
  </section>

  <!-- INGRESOS -->
  <section id="tab-ingresos" class="tab" hidden>
    <div class="grid">
      <div class="card">
        <h2>Agregar ingreso</h2>
        <div class="body">
          <div class="row">
            <div>
              <label>Nombre (quien pagó)</label>
              <input id="inNombre" placeholder="Ej: Lucía Suárez"/>
            </div>
            <div>
              <label>Fecha</label>
              <input id="inFecha" type="date" required/>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Qué pagó</label>
              <input id="inConcepto" placeholder="Ej: CUOTA / EXAMEN / UNIFORME"/>
            </div>
            <div>
              <label>Monto</label>
              <input id="inMonto" type="number" inputmode="decimal" min="0" step="0.01" placeholder="0" required/>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Medio de pago</label>
              <select id="inMedio">
                <option value="Efectivo">Efectivo</option>
                <option value="Transferencia">Transferencia</option>
                <option value="Tarjeta">Tarjeta</option>
                <option value="Otro">Otro</option>
              </select>
            </div>
            <div>
              <label>Estado</label>
              <select id="inEstado">
                <option value="Pagado">Pagado</option>
                <option value="Pendiente">Pendiente</option>
              </select>
            </div>
          </div>
          <div>
            <label>Notas</label>
            <textarea id="inNotas" placeholder="Opcional"></textarea>
          </div>
          <div class="actions">
            <button class="primary" id="addIngresoBtn">Guardar ingreso</button>
            <button class="ghost" id="clearIngresoBtn">Limpiar</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>
          Ingresos
          <span class="badge" id="ingCount">0</span>
        </h2>
        <div class="body">
          <div class="row">
            <div>
              <label>Buscar</label>
              <input id="ingSearch" placeholder="Nombre / concepto..."/>
            </div>
            <div>
              <label>Exportar</label>
              <button class="ghost" id="exportIngresosCsvBtn" style="width:100%;">CSV</button>
            </div>
          </div>
          <div class="table-wrap" style="margin-top:12px;">
            <table>
              <thead>
                <tr>
                  <th>Fecha</th><th>Nombre</th><th>Concepto</th><th>Monto</th><th>Medio</th><th>Estado</th><th>Notas</th><th>Acciones</th>
                </tr>
              </thead>
              <tbody id="ingTbody"></tbody>
            </table>
          </div>
          <p class="small">Sugerencia: usá “Por cobrar” para cargar cuotas pendientes y después marcarlas como pagadas.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- GASTOS -->
  <section id="tab-gastos" class="tab" hidden>
    <div class="grid">
      <div class="card">
        <h2>Agregar egreso</h2>
        <div class="body">
          <div class="row">
            <div>
              <label>Qué pagaste</label>
              <input id="gaConcepto" placeholder="Ej: UTE / OSE / alquiler"/>
            </div>
            <div>
              <label>Fecha</label>
              <input id="gaFecha" type="date" required/>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Monto</label>
              <input id="gaMonto" type="number" inputmode="decimal" min="0" step="0.01" placeholder="0" required/>
            </div>
            <div>
              <label>Categoría</label>
              <input id="gaCategoria" placeholder="Ej: Servicios / Materiales"/>
            </div>
          </div>
          <div>
            <label>Notas</label>
            <textarea id="gaNotas" placeholder="Opcional"></textarea>
          </div>
          <div class="actions">
            <button class="primary" id="addGastoBtn">Guardar egreso</button>
            <button class="ghost" id="clearGastoBtn">Limpiar</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>
          Egresos
          <span class="badge" id="gasCount">0</span>
        </h2>
        <div class="body">
          <div class="row">
            <div>
              <label>Buscar</label>
              <input id="gasSearch" placeholder="Concepto / categoría..."/>
            </div>
            <div>
              <label>Exportar</label>
              <button class="ghost" id="exportGastosCsvBtn" style="width:100%;">CSV</button>
            </div>
          </div>
          <div class="table-wrap" style="margin-top:12px;">
            <table>
              <thead>
                <tr>
                  <th>Fecha</th><th>Concepto</th><th>Categoría</th><th>Monto</th><th>Notas</th><th>Acciones</th>
                </tr>
              </thead>
              <tbody id="gasTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- CXC -->
  <section id="tab-cxc" class="tab" hidden>
    <div class="grid">
      <div class="card">
        <h2>Agregar cuenta por cobrar</h2>
        <div class="body">
          <div class="row">
            <div>
              <label>Alumno / Cliente</label>
              <input id="cxcnombre" placeholder="Ej: Agustín Marino"/>
            </div>
            <div>
              <label>Vencimiento</label>
              <input id="cxcvence" type="date" required/>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Concepto</label>
              <input id="cxcconcepto" placeholder="Ej: CUOTA"/>
            </div>
            <div>
              <label>Monto</label>
              <input id="cxcmonto" type="number" inputmode="decimal" min="0" step="0.01" placeholder="0" required/>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Estado</label>
              <select id="cxcestado">
                <option value="Pendiente">Pendiente</option>
                <option value="Pagado">Pagado</option>
              </select>
            </div>
            <div>
              <label>Notas</label>
              <input id="cxcnotas" placeholder="Opcional"/>
            </div>
          </div>
          <div class="actions">
            <button class="primary" id="addCxcBtn">Guardar</button>
            <button class="ghost" id="clearCxcBtn">Limpiar</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>
          Cuentas por cobrar
          <span class="badge" id="cxcCount">0</span>
        </h2>
        <div class="body">
          <div class="row">
            <div>
              <label>Buscar</label>
              <input id="cxcSearch" placeholder="Nombre / concepto..."/>
            </div>
            <div>
              <label>Exportar</label>
              <button class="ghost" id="exportCxcCsvBtn" style="width:100%;">CSV</button>
            </div>
          </div>
          <div class="table-wrap" style="margin-top:12px;">
            <table>
              <thead>
                <tr>
                  <th>Vence</th><th>Nombre</th><th>Concepto</th><th>Monto</th><th>Estado</th><th>Notas</th><th>Acciones</th>
                </tr>
              </thead>
              <tbody id="cxcTbody"></tbody>
            </table>
          </div>
          <p class="small">Botón “Marcar pagado” crea el ingreso automáticamente.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- CXP -->
  <section id="tab-cxp" class="tab" hidden>
    <div class="grid">
      <div class="card">
        <h2>Agregar cuenta por pagar</h2>
        <div class="body">
          <div class="row">
            <div>
              <label>Proveedor / Servicio</label>
              <input id="cxpproveedor" placeholder="Ej: UTE"/>
            </div>
            <div>
              <label>Vencimiento</label>
              <input id="cxpvence" type="date" required/>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Concepto</label>
              <input id="cxpconcepto" placeholder="Ej: Electricidad"/>
            </div>
            <div>
              <label>Monto</label>
              <input id="cxpmonto" type="number" inputmode="decimal" min="0" step="0.01" placeholder="0" required/>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Estado</label>
              <select id="cxpestado">
                <option value="Pendiente">Pendiente</option>
                <option value="Pagado">Pagado</option>
              </select>
            </div>
            <div>
              <label>Notas</label>
              <input id="cxpnotas" placeholder="Opcional"/>
            </div>
          </div>
          <div class="actions">
            <button class="primary" id="addCxpBtn">Guardar</button>
            <button class="ghost" id="clearCxpBtn">Limpiar</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>
          Cuentas por pagar
          <span class="badge" id="cxpCount">0</span>
        </h2>
        <div class="body">
          <div class="row">
            <div>
              <label>Buscar</label>
              <input id="cxpSearch" placeholder="Proveedor / concepto..."/>
            </div>
            <div>
              <label>Exportar</label>
              <button class="ghost" id="exportCxpCsvBtn" style="width:100%;">CSV</button>
            </div>
          </div>
          <div class="table-wrap" style="margin-top:12px;">
            <table>
              <thead>
                <tr>
                  <th>Vence</th><th>Proveedor</th><th>Concepto</th><th>Monto</th><th>Estado</th><th>Notas</th><th>Acciones</th>
                </tr>
              </thead>
              <tbody id="cxpTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- INVENTARIO -->
  <section id="tab-inventario" class="tab" hidden>
    <div class="grid">
      <div class="card">
        <h2>Agregar / ajustar inventario</h2>
        <div class="body">
          <div class="row">
            <div>
              <label>Categoría</label>
              <input id="invCategoria" placeholder="Ej: Uniformes / Cinturones"/>
            </div>
            <div>
              <label>Producto</label>
              <input id="invProducto" placeholder="Ej: Dobok T3"/>
            </div>
          </div>
          <div class="row3">
            <div>
              <label>Stock</label>
              <input id="invStock" type="number" inputmode="numeric" min="0" step="1" placeholder="0" required/>
            </div>
            <div>
              <label>Stock mínimo</label>
              <input id="invMin" type="number" inputmode="numeric" min="0" step="1" placeholder="0" required/>
            </div>
            <div>
              <label>Costo unitario (opcional)</label>
              <input id="invCosto" type="number" inputmode="decimal" min="0" step="0.01" placeholder="0"/>
            </div>
          </div>
          <div class="actions">
            <button class="primary" id="saveInvBtn">Guardar</button>
            <button class="ghost" id="clearInvBtn">Limpiar</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>
          Inventario
          <span class="badge" id="invCount">0</span>
        </h2>
        <div class="body">
          <div class="row">
            <div>
              <label>Buscar</label>
              <input id="invSearch" placeholder="Categoría / producto..."/>
            </div>
            <div>
              <label>Exportar</label>
              <button class="ghost" id="exportInvCsvBtn" style="width:100%;">CSV</button>
            </div>
          </div>
          <div class="table-wrap" style="margin-top:12px;">
            <table>
              <thead>
                <tr>
                  <th>Categoría</th><th>Producto</th><th>Stock</th><th>Mínimo</th><th>Costo</th><th>Estado</th><th>Acciones</th>
                </tr>
              </thead>
              <tbody id="invTbody"></tbody>
            </table>
          </div>
          <p class="small">Te marca “bajo stock” cuando stock &lt;= mínimo.</p>
        </div>
      </div>
    </div>
  </section>

<!-- ALUMNOS -->
<section id="tab-alumnos" class="tab" hidden>
  <div class="grid">
    <div class="card">
      <h2>Agregar alumno</h2>
      <div class="body">
        <div class="row">
          <div>
            <label>Nombre</label>
            <input id="alNombre" placeholder="Ej: Juan Pérez"/>
          </div>
          <div>
            <label>Fecha de nacimiento</label>
            <input id="alNacimiento" type="date"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Edad (automática)</label>
            <input id="alEdad" type="number" readonly/>
          </div>
          <div>
            <label>Número</label>
            <input id="alNumero" placeholder="Ej: 09xxxxxxx"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Fecha ingreso</label>
            <input id="alIngreso" type="date" required/>
          </div>
          <div>
            <label>Programa</label>
            <select id="alPrograma">
              <option value="BASICO">BASICO</option>
              <option value="BLACK BELT CLUB">BLACK BELT CLUB</option>
              <option value="LIDER">LIDER</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Cuota</label>
            <input id="alCuota" type="number" inputmode="decimal" min="0" step="0.01" placeholder="0" required/>
          </div>
          <div>
            <label>Número ATA</label>
            <input id="alAta" placeholder="Opcional"/>
          </div>
        </div>

        <div class="actions">
          <button class="primary" id="addAlumnoBtn">Guardar alumno</button>
          <button class="ghost" id="clearAlumnoBtn">Limpiar</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>
        Alumnos
        <span class="badge" id="alCount">0</span>
      </h2>
      <div class="body">
        <div class="row">
          <div>
            <label>Buscar</label>
            <input id="alSearch" placeholder="Nombre / número / ATA..."/>
          </div>
          <div>
            <label>Exportar</label>
            <button class="ghost" id="exportAlumnosCsvBtn" style="width:100%;">CSV</button>
          </div>
        </div>

        <div class="table-wrap" style="margin-top:12px;">
          <table>
            <thead>
              <tr>
                <th>Nombre</th><th>Nacimiento</th><th>Edad</th><th>Número</th><th>Ingreso</th><th>Programa</th><th>Cuota</th><th>ATA</th><th>Acciones</th>
              </tr>
            </thead>
            <tbody id="alTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</section>
  
  <!-- PLANTILLAS -->
  <section id="tab-plantillas" class="tab" hidden>
    <div class="card">
      <h2>Plantillas (meses)</h2>
      <div class="body">
        <p class="small">
          Cada <strong>plantilla</strong> es como “un mes” (o un período). Podés crear una nueva y copiar la anterior para seguir sin arrancar de cero.
        </p>

        <div class="row">
          <div>
            <label>Nombre de la nueva plantilla</label>
            <input id="tplName" placeholder="Ej: 2025-12"/>
          </div>
          <div>
            <label>Acción</label>
            <button class="primary" id="createTplBtn" style="width:100%;">Crear (vacía)</button>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div>
            <label>Copiar desde plantilla</label>
            <select id="tplCloneFrom"></select>
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="ghost" id="cloneTplBtn" style="width:100%;">Crear copiando</button>
          </div>
        </div>

        <hr style="border:none;border-top:1px solid var(--border);margin:14px 0;"/>

        <div class="row">
          <div>
            <label>Plantilla activa</label>
            <select id="tplActive"></select>
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="ghost danger" id="deleteTplBtn" style="width:100%;">Borrar plantilla activa</button>
          </div>
        </div>

        <div class="actions">
          <button class="ghost" id="importBackupBtn">Importar respaldo (JSON)</button>
        </div>

        <input id="filePicker" type="file" accept="application/json" hidden/>
      </div>
    </div>
  </section>
</main>

<footer>
  <div class="footer-inner">
    <div class="small">Datos guardados en el iPhone (sin internet). Hacé respaldos seguido.</div>
    <div class="small">v2 — Xtreme Academy</div>
  </div>
</footer>

<script type="module">
import { highlightTerm, matchesQuery, uid } from "./utils.js";

const searchInput = document.getElementById("directorySearch");
const searchFeedback = document.getElementById("directorySearchFeedback");
const bodyEl = document.body;

function showDirectoryNotice(message) {
  const host = document.getElementById("appAlerts");
  if (!host || !message) return;

  const el = document.createElement("div");
  el.className = "app-alert";
  el.textContent = message;
  host.appendChild(el);
  requestAnimationFrame(() => el.classList.add("visible"));
  setTimeout(() => {
    el.classList.remove("visible");
    setTimeout(() => el.remove(), 200);
  }, 3600);
}

function getDirectories() {
  return Array.from(document.querySelectorAll("[data-filter-section]")).map((list) => ({
    list,
    items: Array.from(list.querySelectorAll("[data-label]")).map((item) => ({
      el: item,
      label: item.dataset.label || item.textContent || ""
    })),
    empty: list.parentElement.querySelector(".directory-empty")
  }));
}

function renderDirectorySearch() {
  const query = (searchInput?.value || "").trim();
  const directories = getDirectories();
  let totalVisible = 0;
  const sectionCounts = [];

  directories.forEach(({ list, items, empty }) => {
    const sectionLabel = list.dataset.sectionLabel || "";
    list.setAttribute("aria-busy", "true");
    let visible = 0;

    items.forEach(({ el, label }) => {
      const match = matchesQuery(label, query);
      el.hidden = !match;
      const target = el.querySelector(".directory-item__text");
      if (target) {
        target.innerHTML = highlightTerm(label, query);
      }
      if (match) visible += 1;
    });

    if (empty) {
      const defaultMsg = empty.dataset.emptyDefault || empty.textContent || "";
      const label = sectionLabel ? sectionLabel.toLowerCase() : "resultados";
      empty.textContent = query ? `Sin ${label} que coincidan con “${query}”.` : defaultMsg;
      empty.hidden = visible > 0;
      empty.setAttribute("aria-hidden", visible > 0 ? "true" : "false");
    }

    sectionCounts.push({ label: sectionLabel, count: visible });
    totalVisible += visible;
    list.setAttribute("aria-busy", "false");
  });

  if (searchFeedback) {
    if (!query) {
      const totalItems = sectionCounts.reduce((acc, curr) => acc + curr.count, 0);
      searchFeedback.textContent = `Mostrando todo el directorio (${totalItems} elementos).`;
    } else if (totalVisible > 0) {
      const detail = sectionCounts
        .filter((s) => s.count > 0)
        .map((s) => `${s.count} en ${s.label}`)
        .join(" · ");
      searchFeedback.textContent = `${totalVisible} resultado${totalVisible === 1 ? "" : "s"} para “${query}”${detail ? `: ${detail}` : ""}.`;
    } else {
      searchFeedback.textContent = `Sin coincidencias para “${query}” en el directorio.`;
    }
  }
}

if (searchInput) {
  searchInput.addEventListener("input", renderDirectorySearch);
  renderDirectorySearch();
}

const directoryPanel = document.getElementById("directoryPanel");
const financePanel = document.getElementById("financePanel");
const directoryButtons = Array.from(document.querySelectorAll("[data-directory-target]"));
const backToFinanceBtn = document.getElementById("backToFinanceBtn");
const directoryToggle = document.getElementById("directoryToggle");
const DIRECTORY_STORE_KEY = "xa_directory_v1";
const DIRECTORY_AUTH_KEY = "xa_directory_auth_ok";
const DIRECTORY_PASSWORD = "frente1234";
let directoryUnlocked = false;
let authPromptOpen = false;

let directoryState = {
  clases: [
    { id: uid(), nombre: "Infantiles", horario: "Lunes 18:00", sede: "Do Jang Norte" },
    { id: uid(), nombre: "Juveniles", horario: "Martes 19:00", sede: "Do Jang Sur" },
    { id: uid(), nombre: "Adultos", horario: "Jueves 20:00", sede: "Sede Central" }
  ],
  profes: [
    { id: uid(), nombre: "Sensei Lucía Suárez", foco: "Infantiles", clases: [] },
    { id: uid(), nombre: "Profe Martín Vega", foco: "Juveniles", clases: [] },
    { id: uid(), nombre: "Coach Ana Díaz", foco: "Adultos", clases: [] }
  ]
};

function loadDirectoryState() {
  try {
    const raw = localStorage.getItem(DIRECTORY_STORE_KEY);
    const parsed = raw ? JSON.parse(raw) : null;
    if (parsed && typeof parsed === "object") {
      directoryState = {
        clases: Array.isArray(parsed.clases) ? parsed.clases : directoryState.clases,
        profes: Array.isArray(parsed.profes) ? parsed.profes : directoryState.profes
      };
    }
  } catch (err) {
    console.warn("No se pudo cargar el directorio", err);
  }
}

function saveDirectoryState() {
  try {
    localStorage.setItem(DIRECTORY_STORE_KEY, JSON.stringify(directoryState));
    showDirectoryNotice("✅ Cambios guardados en el directorio");
  } catch (err) {
    console.warn("No se pudo guardar el directorio", err);
    showDirectoryNotice("⚠️ No se pudo guardar el directorio");
  }
}

loadDirectoryState();

function setActiveDirectoryButton(targetId) {
  directoryButtons.forEach((btn) => {
    const isActive = btn.dataset.directoryTarget === targetId;
    btn.classList.toggle("active", isActive);
    btn.setAttribute("aria-pressed", isActive ? "true" : "false");
  });
}

function setDirectoryMenu(open) {
  if (directoryToggle) {
    directoryToggle.setAttribute("aria-expanded", open ? "true" : "false");
  }
  if (bodyEl) {
    bodyEl.classList.toggle("directory-menu-open", open);
  }
}

async function showDirectory(targetId) {
  const ok = await ensureDirectoryAccess();
  if (!ok) return false;
  if (directoryPanel) directoryPanel.hidden = false;
  if (financePanel) financePanel.hidden = true;
  document.body.classList.add("view-directory");
  setActiveDirectoryButton(targetId);

  if (targetId) {
    const card = document.getElementById(targetId);
    if (card) {
      card.setAttribute("tabindex", "-1");
      card.scrollIntoView({ behavior: "smooth", block: "start" });
      card.focus({ preventScroll: true });
    }
  }
  return true;
}

function showFinance() {
  if (directoryPanel) directoryPanel.hidden = true;
  if (financePanel) financePanel.hidden = false;
  document.body.classList.remove("view-directory");
  setDirectoryMenu(false);
  setActiveDirectoryButton("");
  directoryUnlocked = false;
  try { localStorage.removeItem(DIRECTORY_AUTH_KEY); } catch (_err) { /* ignore */ }
}

directoryButtons.forEach((btn) => {
  btn.addEventListener("click", async () => {
    const targetId = btn.dataset.directoryTarget;
    const opened = await showDirectory(targetId);
    if (opened) renderDirectorySearch();
  });
});

if (directoryToggle) {
  directoryToggle.addEventListener("click", async () => {
    const ok = await ensureDirectoryAccess();
    if (!ok) return;
    const isOpen = bodyEl.classList.contains("directory-menu-open");
    setDirectoryMenu(!isOpen);
  });
}

if (backToFinanceBtn) {
  backToFinanceBtn.addEventListener("click", showFinance);
}

// Start in vista finanzas
showFinance();

function ensureDirectoryAccess() {
  try {
    if (directoryUnlocked || localStorage.getItem(DIRECTORY_AUTH_KEY) === "1") {
      directoryUnlocked = true;
      return Promise.resolve(true);
    }
  } catch (_e) {
    // ignore read error, fallback to prompt
  }
  if (authPromptOpen) return Promise.resolve(false);
  return new Promise((resolve) => {
    const lastFocused = document.activeElement;
    authPromptOpen = true;
    const overlay = document.createElement("div");
    overlay.className = "directory-auth-overlay";
    overlay.innerHTML = `
      <div class="directory-auth-modal" role="dialog" aria-modal="true" aria-labelledby="directoryAuthTitle" aria-describedby="directoryAuthDesc" tabindex="-1">
        <div class="directory-auth-modal__header">
          <h3 id="directoryAuthTitle">Ingresá la contraseña</h3>
          <button type="button" class="ghost directory-auth-close" data-auth-close aria-label="Cerrar diálogo de contraseña">✕</button>
        </div>
        <p class="small" id="directoryAuthDesc">Necesitamos la clave para entrar al directorio.</p>
        <label class="sr-only" for="directoryPasswordInput">Contraseña</label>
        <input id="directoryPasswordInput" type="password" autocomplete="current-password" placeholder="********" inputmode="text" />
        <div class="directory-auth-error small" aria-live="polite" aria-atomic="true"></div>
        <div class="directory-auth-actions">
          <button type="button" class="ghost" data-auth-cancel>Cancelar</button>
          <button type="button" class="primary" data-auth-submit>Entrar</button>
        </div>
      </div>
    `;

    const input = overlay.querySelector("#directoryPasswordInput");
    const submitBtn = overlay.querySelector("[data-auth-submit]");
    const cancelBtn = overlay.querySelector("[data-auth-cancel]");
    const closeBtn = overlay.querySelector("[data-auth-close]");
    const errorBox = overlay.querySelector(".directory-auth-error");
    const modal = overlay.querySelector(".directory-auth-modal");

    function cleanup() {
      authPromptOpen = false;
      overlay.remove();
      document.body.classList.remove("modal-open");
      lastFocused?.focus?.();
    }

    function deny(msg) {
      if (errorBox) {
        errorBox.textContent = msg || "";
      }
      if (input) {
        input.focus();
        input.select?.();
      }
    }

    function approve() {
      directoryUnlocked = true;
      try { localStorage.setItem(DIRECTORY_AUTH_KEY, "1"); } catch (_err) { /* ignore */ }
      cleanup();
      resolve(true);
    }

    function cancel() {
      cleanup();
      resolve(false);
    }

    function handleSubmit() {
      const val = (input?.value || "").trim();
      if (val === DIRECTORY_PASSWORD) {
        approve();
      } else {
        deny("Contraseña incorrecta.");
      }
    }

    overlay.addEventListener("click", (e) => {
      if (e.target === overlay) cancel();
    });

    function trapFocus(e) {
      if (e.key !== "Tab") return;
      const focusable = Array.from(overlay.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'))
        .filter((el) => !el.hasAttribute("disabled"));
      if (!focusable.length) return;
      const first = focusable[0];
      const last = focusable[focusable.length - 1];
      if (e.shiftKey && document.activeElement === first) {
        e.preventDefault();
        last.focus();
      } else if (!e.shiftKey && document.activeElement === last) {
        e.preventDefault();
        first.focus();
      }
    }

    overlay.addEventListener("keydown", trapFocus);

    if (submitBtn) submitBtn.addEventListener("click", handleSubmit);
    if (cancelBtn) cancelBtn.addEventListener("click", cancel);
    if (closeBtn) closeBtn.addEventListener("click", cancel);
    if (input) {
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          handleSubmit();
        }
        if (e.key === "Escape") {
          e.preventDefault();
          cancel();
        }
      });
    }

    document.body.appendChild(overlay);
    document.body.classList.add("modal-open");
    (modal || input)?.focus();
    input?.select?.();
  });
}

/* ----- Gestión de clases ----- */
const classForm = document.getElementById("classForm");
const classNameInput = document.getElementById("className");
const classScheduleInput = document.getElementById("classSchedule");
const classLocationInput = document.getElementById("classLocation");
const classIdInput = document.getElementById("classId");
const classCancelBtn = document.getElementById("classCancelBtn");
const classesList = document.getElementById("classesList");

function resetClassForm() {
  classForm?.reset();
  classIdInput.value = "";
  classNameInput?.focus();
}

function handleClassSubmit(e) {
  e.preventDefault();
  const payload = {
    nombre: (classNameInput.value || "").trim(),
    horario: (classScheduleInput.value || "").trim(),
    sede: (classLocationInput.value || "").trim()
  };
  if (!payload.nombre) return;

  const id = classIdInput.value;
  if (id) {
    const idx = directoryState.clases.findIndex((c) => c.id === id);
    if (idx >= 0) directoryState.clases[idx] = { ...directoryState.clases[idx], ...payload };
  } else {
    directoryState.clases.push({ id: uid(), ...payload });
  }

  saveDirectoryState();
  renderClasses();
  renderTeachers();
  renderDirectorySearch();
  resetClassForm();
}

function handleClassEdit(id) {
  const c = directoryState.clases.find((x) => x.id === id);
  if (!c) return;
  classNameInput.value = c.nombre || "";
  classScheduleInput.value = c.horario || "";
  classLocationInput.value = c.sede || "";
  classIdInput.value = c.id;
  classNameInput.focus();
}

function handleClassDelete(id) {
  directoryState.clases = directoryState.clases.filter((c) => c.id !== id);
  directoryState.profes = directoryState.profes.map((p) => ({
    ...p,
    clases: (p.clases || []).filter((cid) => cid !== id)
  }));
  saveDirectoryState();
  renderClasses();
  renderTeachers();
  renderDirectorySearch();
}

function renderClasses() {
  if (!classesList) return;
  classesList.innerHTML = "";
  const items = directoryState.clases;
  const empty = classesList.parentElement?.querySelector(".directory-empty");
  if (empty) {
    empty.hidden = items.length > 0;
    empty.setAttribute("aria-hidden", items.length > 0 ? "true" : "false");
  }

  items.forEach((c) => {
    const label = `${c.nombre}${c.horario ? ` · ${c.horario}` : ""}`;
    const item = document.createElement("div");
    item.className = "directory-item";
    item.setAttribute("role", "listitem");
    item.dataset.label = label;
    item.innerHTML = `
      <span class="directory-item__text">${highlightTerm(label, searchInput?.value || "")}</span>
      <div class="directory-item__actions">
        ${c.sede ? `<span class="tag">${highlightTerm(c.sede, searchInput?.value || "")}</span>` : ""}
        <button type="button" class="ghost" data-act="edit" aria-label="Editar clase ${label}" data-id="${c.id}">Editar</button>
        <button type="button" class="ghost danger" data-act="del" aria-label="Borrar clase ${label}" data-id="${c.id}">Borrar</button>
      </div>
    `;
    classesList.appendChild(item);
  });

  classesList.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-act]");
    if (!btn) return;
    const id = btn.dataset.id;
    const act = btn.dataset.act;
    if (act === "edit") handleClassEdit(id);
    if (act === "del") handleClassDelete(id);
  }, { once: true });

  buildTeacherClassOptions();
}

classForm?.addEventListener("submit", handleClassSubmit);
classCancelBtn?.addEventListener("click", resetClassForm);

/* ----- Gestión de profes ----- */
const teacherForm = document.getElementById("teacherForm");
const teacherNameInput = document.getElementById("teacherName");
const teacherFocusInput = document.getElementById("teacherFocus");
const teacherClassesSelect = document.getElementById("teacherClasses");
const teacherIdInput = document.getElementById("teacherId");
const teacherCancelBtn = document.getElementById("teacherCancelBtn");
const teachersList = document.getElementById("teachersList");

function buildTeacherClassOptions() {
  if (!teacherClassesSelect) return;
  const selected = new Set(Array.from(teacherClassesSelect.selectedOptions).map((o) => o.value));
  teacherClassesSelect.innerHTML = "";
  directoryState.clases.forEach((c) => {
    const opt = document.createElement("option");
    opt.value = c.id;
    opt.textContent = `${c.nombre}${c.horario ? ` · ${c.horario}` : ""}`;
    if (selected.has(c.id)) opt.selected = true;
    teacherClassesSelect.appendChild(opt);
  });
}

function resetTeacherForm() {
  teacherForm?.reset();
  teacherIdInput.value = "";
  buildTeacherClassOptions();
  teacherNameInput?.focus();
}

function handleTeacherSubmit(e) {
  e.preventDefault();
  const payload = {
    nombre: (teacherNameInput.value || "").trim(),
    foco: (teacherFocusInput.value || "").trim(),
    clases: Array.from(teacherClassesSelect?.selectedOptions || []).map((o) => o.value)
  };
  if (!payload.nombre) return;

  const id = teacherIdInput.value;
  if (id) {
    const idx = directoryState.profes.findIndex((p) => p.id === id);
    if (idx >= 0) directoryState.profes[idx] = { ...directoryState.profes[idx], ...payload };
  } else {
    directoryState.profes.push({ id: uid(), ...payload });
  }
  saveDirectoryState();
  renderTeachers();
  renderDirectorySearch();
  resetTeacherForm();
}

function handleTeacherEdit(id) {
  const p = directoryState.profes.find((x) => x.id === id);
  if (!p) return;
  teacherNameInput.value = p.nombre || "";
  teacherFocusInput.value = p.foco || "";
  buildTeacherClassOptions();
  Array.from(teacherClassesSelect.options).forEach((opt) => {
    opt.selected = (p.clases || []).includes(opt.value);
  });
  teacherIdInput.value = p.id;
  teacherNameInput.focus();
}

function handleTeacherDelete(id) {
  directoryState.profes = directoryState.profes.filter((p) => p.id !== id);
  saveDirectoryState();
  renderTeachers();
  renderDirectorySearch();
}

function renderTeachers() {
  if (!teachersList) return;
  teachersList.innerHTML = "";
  const classesById = Object.fromEntries(directoryState.clases.map((c) => [c.id, c]));
  const empty = teachersList.parentElement?.querySelector(".directory-empty");
  if (empty) {
    empty.hidden = directoryState.profes.length > 0;
    empty.setAttribute("aria-hidden", directoryState.profes.length > 0 ? "true" : "false");
  }

  directoryState.profes.forEach((p) => {
    const classLabels = (p.clases || []).map((id) => classesById[id]?.nombre || "").filter(Boolean);
    const label = p.nombre;
    const item = document.createElement("div");
    item.className = "directory-item";
    item.setAttribute("role", "listitem");
    item.dataset.label = label;
    item.innerHTML = `
      <div class="directory-item__main">
        <span class="directory-item__text">${highlightTerm(label, searchInput?.value || "")}</span>
        ${p.foco ? `<span class="small directory-item__hint">${highlightTerm(p.foco, searchInput?.value || "")}</span>` : ""}
        ${classLabels.length ? `<div class="directory-item__tags">${classLabels.map((t) => `<span class="tag">${highlightTerm(t, searchInput?.value || "")}</span>`).join("")}</div>` : ""}
      </div>
      <div class="directory-item__actions">
        <button type="button" class="ghost" data-act="edit" aria-label="Editar profesor ${label}" data-id="${p.id}">Editar</button>
        <button type="button" class="ghost danger" data-act="del" aria-label="Borrar profesor ${label}" data-id="${p.id}">Borrar</button>
      </div>
    `;
    teachersList.appendChild(item);
  });

  teachersList.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-act]");
    if (!btn) return;
    const id = btn.dataset.id;
    const act = btn.dataset.act;
    if (act === "edit") handleTeacherEdit(id);
    if (act === "del") handleTeacherDelete(id);
  }, { once: true });
}

teacherForm?.addEventListener("submit", handleTeacherSubmit);
teacherCancelBtn?.addEventListener("click", resetTeacherForm);

renderClasses();
renderTeachers();
renderDirectorySearch();
</script>
<script type="module" src="./app.js?v=161"></script>
</body>
</html>
